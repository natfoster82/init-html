<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Aralia Fabian</title>
</head>
<style></style>
<div id="buttons">
  <button onclick="SELF.click(event)" data-show="home">Home</div>
</div>
<div id="divs">
  <div id="home" style="width:100%;height:100%"></div>
</div>
</main>
<footer>
</footer>
<script src="https://unpkg.com/peerjs@1.2.0/dist/peerjs.min.js"></script>
<script type="text/javascript">
const SELF = {
  memory: {
    peer: null,
    apps: {},
    names: {},
    tmp: {}
  },
  init: () => {
    for (let [key, code] of Object.entries(DEFAULT_APPS)) localStorage.setItem(key, code)
    SELF.loadApps()
    // i put my own home in the dom, kinda like a desktop, always there
    document.getElementById('home').innerHTML = SELF.get('home')
    const PEER_SERVER_HOST =  window.prompt('PEER_SERVER_HOST', localStorage.getItem('PEER_SERVER_HOST') || 'peerjspoc.caveon.com')
    localStorage.setItem('PEER_SERVER_HOST', PEER_SERVER_HOST)

    const MY_ID = window.prompt('MY_ID (leave blank for random)', localStorage.getItem('MY_ID') || '')
    localStorage.setItem('MY_ID', MY_ID)

    SELF.memory.peer = new Peer(MY_ID, {
      host: localStorage.getItem('PEER_SERVER_HOST'),
      path: localStorage.getItem('PEER_SERVER_PATH') || '/myapp',
      port: localStorage.getItem('PEER_SERVER_PORT') || ''
    })
    SELF.memory.peer.on('open', (id) => {
      SELF.memory.peer.on('connection', (conn) => {
        SELF.configure(conn)
      })
    })
  },
  get: (key, payload, conn) => {
    const appKey = '_' + key
    if (SELF.memory.apps.hasOwnProperty(appKey)) {
      return SELF.memory.apps[appKey](payload, conn)
    }
    return localStorage.getItem(key)
  },
  loadApps: (key) => {
    SELF.memory.apps = {}
    for (let key of Object.keys(localStorage)) {
      if (!key.startsWith('_')) continue
      const code = localStorage.getItem(key)
      SELF.memory.apps[key] = new Function(code)
    }
  },
  accept: (payload, conn) => {
    console.log('accept', payload, conn)
    // i route based on payload.app and payload._meta.apps
    // please send my meta back intact at _meta whenever you can
    if (payload.app) {
      SELF.memory.apps[payload.app](payload, conn)
    } else {
      for (let app of payload._meta.apps) {
        try {
          SELF.memory.apps[app](payload, conn)
        } catch (e) {
          console.error('app error', app, e, payload, conn)
        }
      }
    }
  },
  connect: (id) => {
    const conn = SELF.memory.peer.connect(id)
    SELF.configure(conn)
    return conn
  },
  configure: (conn, id) => {
    setTimeout(() => {
      // what is your name?
      conn.send({app: '_get', meta: {key: 'name', apps: ['_name']}})
    }, 50)
    conn.on('data', (payload) => {
      SELF.accept(payload, conn)
    })
  },
  click: (e) => {
    // all i do is show stuff for now
    if (e.target.dataset.show) {
      const divs = document.getElementById('divs').querySelectorAll('div')
      let showDiv
      for (const div of divs) {
        if (div.id === e.target.dataset.show) showDiv = div
        div.style.display = 'none'
      }
      showDiv.style.display = 'block'
    }
  },
  viewHtml: (key, conn) => {
    console.log(conn)
    const id = SELF.makeButton(`${SELF.memory.names[conn.peer] || conn.peer} - ${key}`)
    SELF.send({app: '_get', meta: {key: 'home', id: id, apps: ['_html']}}, conn)
  },
  send: (payload, conn) => {
    if (conn) return conn.send(payload)
    return SELF.accept(payload, conn)
  },
  makeButton: (text) => {
    const id = Math.random().toString(36).replace(/[^a-z]+/g, '').substr(0, 5)
    const button = document.createElement('button')
    button.dataset.show = id
    button.innerHTML = text
    document.getElementById('buttons').appendChild(button)
    const div = document.createElement('div')
    div.id = id
    document.getElementById('divs').appendChild(div)
    return id
  }
}


// set the default package
const DEFAULT_APPS = {
  _home: `// home
const [payload, conn] = arguments
return \`
<p>Welcome to my home!</p>
<p>Or is it yours?</p>
<p>Either way, pardon the construction.</p>
<input type="text" placeholder="nat">
<button onclick="const conn = SELF.connect(event.target.previousSibling.value);SELF.viewHtml('home', conn)">Connect</button>
\`
`,
  _vera: `// a page for vera
return \`Dear Vera,

This message is coming straight from my open browser tab, no web servers between us.

This is the closest we've ever been.

I'll leave beautiful things here for you.

Nat\`
`,
  _get: `// takes payload.meta.key and sends a value
const [payload, conn] = arguments
const key = payload.meta.key
const value = SELF.get(key)
// because i'm nice i'll send your meta back at _meta
SELF.send({data: value, _meta: payload.meta}, conn)
`,
  _name: `// takes payload.data and sets it as your name in my memory
const [payload, conn] = argument
SELF.memory.names[conn.peer] = payload.data
`,
  _set: '// yeah right',
  _html: `// takes payload.data and loads it into the innerHTML at payload._meta.id
const [payload, conn] = arguments
let el = document.getElementById(payload._meta.id)
el.innerHTML = payload.data
const more = el.querySelectorAll('[data-get]');
for (const moreEl of more.values()) {
  SELF.send({app: '_get', meta: {key: moreEl.dataset.get, id: moreEl.id, apps: ['_html']}}, conn)
}
`
}

const APP_TEMPLATES = {
_helloWorld: `// returns html for _html
const [payload, conn] = arguments
return \`
  <style>
    h3 {
      color:blue;
    }
  </style>
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <!-- you'll need to put title in -->
        <h3>\${localStorage.getItem('title') || 'Hello world!'}</h3>
        <!-- you can also use data-get attributes to load more data -->
        <div id="subtitle" data-get="subtitle"></div>
      </div>
    </div>
  </div>
\`
`
}
SELF.init()
</script>
</body>
</html>
